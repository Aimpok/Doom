<!DOCTYPE html>
<html>
<head>
    <title>3D Лабиринт</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* ... (все стили остаются без изменений) ... */
    </style>
</head>
<body>
    <!-- ... (HTML структура без изменений) ... -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Конфигурация
        const API_BASE_URL = 'https://your-bot-server.com'; // Замените на ваш сервер
        let userToken = null;
        let userId = null;

        // Получение userId из Telegram Mini Apps
        function getTelegramUserId() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    return Telegram.WebApp.initDataUnsafe.user?.id.toString();
                }
            } catch (e) {
                console.log('Не в Telegram Web App');
            }
            return null;
        }

        // Инициализация пользователя
        async function initializeUser() {
            userId = getTelegramUserId();
            
            if (!userId) {
                console.log('UserId не найден, используем локальное хранилище');
                return false;
            }

            try {
                // Получаем токен от бота
                const response = await fetch(`${API_BASE_URL}/api/get-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });

                if (response.ok) {
                    const data = await response.json();
                    userToken = data.token;
                    console.log('Токен получен успешно');
                    return true;
                } else {
                    console.log('Ошибка получения токена');
                    return false;
                }
            } catch (error) {
                console.log('Ошибка подключения к серверу:', error);
                return false;
            }
        }

        // Система сохранения настроек через бота
        class BotSettingsManager {
            constructor() {
                this.defaultSettings = {
                    musicVolume: 50,
                    soundVolume: 50,
                    sensitivity: 5
                };
                this.settings = {...this.defaultSettings};
                this.isConnected = false;
            }

            async initialize() {
                this.isConnected = await initializeUser();
                
                if (this.isConnected) {
                    await this.loadFromBot();
                } else {
                    this.loadFromLocalStorage();
                }
                
                this.applySettings();
                return this.isConnected;
            }

            async loadFromBot() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/settings`, {
                        headers: {
                            'Authorization': userToken,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.settings = {...this.defaultSettings, ...data};
                        console.log('Настройки загружены из бота');
                    } else {
                        throw new Error('Ошибка загрузки настроек');
                    }
                } catch (error) {
                    console.log('Ошибка загрузки из бота:', error);
                    this.loadFromLocalStorage();
                }
            }

            async saveToBot() {
                if (!this.isConnected) {
                    this.saveToLocalStorage();
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/settings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': userToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.settings)
                    });

                    if (!response.ok) {
                        throw new Error('Ошибка сохранения настроек');
                    }
                    console.log('Настройки сохранены в бота');
                } catch (error) {
                    console.log('Ошибка сохранения в бота:', error);
                    this.saveToLocalStorage();
                }
            }

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('doomMazeSettings');
                    if (saved) {
                        this.settings = {...this.defaultSettings, ...JSON.parse(saved)};
                    }
                    console.log('Настройки загружены из localStorage');
                } catch (e) {
                    console.log('Ошибка загрузки из localStorage');
                }
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('doomMazeSettings', JSON.stringify(this.settings));
                    console.log('Настройки сохранены в localStorage');
                } catch (e) {
                    console.log('Ошибка сохранения в localStorage');
                }
            }

            applySettings() {
                const musicSlider = document.getElementById('musicVolumeSlider');
                const soundSlider = document.getElementById('soundVolumeSlider');
                const sensitivitySlider = document.getElementById('sensitivitySlider');
                
                if (musicSlider) musicSlider.value = this.settings.musicVolume;
                if (soundSlider) soundSlider.value = this.settings.soundVolume;
                if (sensitivitySlider) sensitivitySlider.value = this.settings.sensitivity;
            }

            async updateSetting(key, value) {
                if (this.settings.hasOwnProperty(key)) {
                    this.settings[key] = value;
                    await this.saveToBot();
                    return true;
                }
                return false;
            }

            get musicVolume() { return this.settings.musicVolume; }
            get soundVolume() { return this.settings.soundVolume; }
            get sensitivity() { return this.settings.sensitivity; }
            
            set musicVolume(value) { this.updateSetting('musicVolume', value); }
            set soundVolume(value) { this.updateSetting('soundVolume', value); }
            set sensitivity(value) { this.updateSetting('sensitivity', value); }
        }

        // Создаем менеджер настроек
        const settingsManager = new BotSettingsManager();

        // Остальной код игры (Three.js сцена, управление и т.д.)
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x87CEEB, 20, 50);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87CEEB);
        document.body.appendChild(renderer.domElement);

        // ... (остальной код игры без изменений) ...

        // Переменные управления
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let yaw = 0;
        let pitch = 0;
        const PI_2 = Math.PI / 2;

        // Настройки будут применены после загрузки
        let mouseSensitivity = 0.002;
        let musicVolume = 0.5;
        let soundVolume = 0.5;

        // Инициализация аудио
        function initAudio() {
            console.log('Аудио система инициализирована');
            musicVolume = settingsManager.musicVolume / 100;
            soundVolume = settingsManager.soundVolume / 100;
            mouseSensitivity = settingsManager.sensitivity * 0.0004;
        }

        // Инициализация меню
        async function initMenu() {
            console.log('Инициализация меню...');
            
            // Инициализируем менеджер настроек
            const isConnected = await settingsManager.initialize();
            
            // Показываем статус подключения
            if (isConnected) {
                console.log('✅ Настройки синхронизируются с ботом');
            } else {
                console.log('⚠️ Используется локальное хранилище');
            }
            
            // Инициализируем аудио с настройками
            initAudio();
            
            // Настраиваем обработчики слайдеров
            document.getElementById('sensitivitySlider').addEventListener('input', function(e) {
                const sensitivity = parseInt(e.target.value);
                mouseSensitivity = sensitivity * 0.0004;
                settingsManager.sensitivity = sensitivity;
            });

            document.getElementById('musicVolumeSlider').addEventListener('input', function(e) {
                const volume = parseInt(e.target.value);
                musicVolume = volume / 100;
                settingsManager.musicVolume = volume;
            });

            document.getElementById('soundVolumeSlider').addEventListener('input', function(e) {
                const volume = parseInt(e.target.value);
                soundVolume = volume / 100;
                settingsManager.soundVolume = volume;
            });
            
            // Обработчики кнопок меню
            document.getElementById('playButton').addEventListener('click', startGame);
            document.getElementById('optionsButton').addEventListener('click', showOptions);
            document.getElementById('backButton').addEventListener('click', hideOptions);
            
            console.log('Меню инициализировано');
        }

        // Функция запуска игры
        function startGame() {
            console.log('Запуск игры...');
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('optionsMenu').style.display = 'none';
            
            // Показываем UI игры
            const fpsCounter = document.getElementById('fpsCounter');
            const uiPanel = document.getElementById('uiPanel');
            const weapon = document.getElementById('weapon');
            
            if (fpsCounter) fpsCounter.style.display = 'block';
            if (uiPanel) uiPanel.style.display = 'block';
            if (weapon) weapon.style.display = 'block';
            
            // Запускаем игровой цикл
            animate();
        }

        // Игровой цикл
        function animate() {
            requestAnimationFrame(animate);
            
            // Обновление движения
            const direction = new THREE.Vector3();
            const moveSpeed = 0.2;
            
            if (moveForward) direction.z -= moveSpeed;
            if (moveBackward) direction.z += moveSpeed;
            if (moveLeft) direction.x -= moveSpeed;
            if (moveRight) direction.x += moveSpeed;
            
            direction.applyEuler(new THREE.Euler(0, yaw, 0));
            camera.position.add(direction);
            
            // Обновление вращения
            camera.rotation.order = 'YXZ';
            camera.rotation.y = yaw;
            camera.rotation.x = pitch;
            
            renderer.render(scene, camera);
        }

        // Управление
        function initControls() {
            // Клавиатура
            window.addEventListener('keydown', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    switch(event.code) {
                        case 'KeyW': moveForward = true; break;
                        case 'KeyS': moveBackward = true; break;
                        case 'KeyA': moveLeft = true; break;
                        case 'KeyD': moveRight = true; break;
                    }
                }
            });
            
            window.addEventListener('keyup', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    switch(event.code) {
                        case 'KeyW': moveForward = false; break;
                        case 'KeyS': moveBackward = false; break;
                        case 'KeyA': moveLeft = false; break;
                        case 'KeyD': moveRight = false; break;
                    }
                }
            });

            // Мышь
            document.addEventListener('mousemove', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    yaw -= event.movementX * mouseSensitivity;
                    pitch -= event.movementY * mouseSensitivity;
                    pitch = Math.max(-PI_2, Math.min(PI_2, pitch));
                }
            });
        }

        // Запуск игры
        async function initGame() {
            try {
                // Создаем простую сцену для теста
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);

                // Инициализируем управление
                initControls();
                
                // Инициализируем меню
                await initMenu();
                
                console.log('🎮 Игра готова к запуску!');
                
            } catch (error) {
                console.error('Ошибка инициализации игры:', error);
            }
        }

        // Запускаем игру при загрузке
        initGame();
    </script>
</body>
</html>
