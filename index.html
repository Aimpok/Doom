<!DOCTYPE html>
<html>
<head>
    <title>3D –õ–∞–±–∏—Ä–∏–Ω—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    </style>
</head>
<body>
    <!-- ... (HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE_URL = 'https://your-bot-server.com'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
        let userToken = null;
        let userId = null;

        // –ü–æ–ª—É—á–µ–Ω–∏–µ userId –∏–∑ Telegram Mini Apps
        function getTelegramUserId() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    return Telegram.WebApp.initDataUnsafe.user?.id.toString();
                }
            } catch (e) {
                console.log('–ù–µ –≤ Telegram Web App');
            }
            return null;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initializeUser() {
            userId = getTelegramUserId();
            
            if (!userId) {
                console.log('UserId –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
                return false;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –æ—Ç –±–æ—Ç–∞
                const response = await fetch(`${API_BASE_URL}/api/get-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });

                if (response.ok) {
                    const data = await response.json();
                    userToken = data.token;
                    console.log('–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    return true;
                } else {
                    console.log('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
                    return false;
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É:', error);
                return false;
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
        class BotSettingsManager {
            constructor() {
                this.defaultSettings = {
                    musicVolume: 50,
                    soundVolume: 50,
                    sensitivity: 5
                };
                this.settings = {...this.defaultSettings};
                this.isConnected = false;
            }

            async initialize() {
                this.isConnected = await initializeUser();
                
                if (this.isConnected) {
                    await this.loadFromBot();
                } else {
                    this.loadFromLocalStorage();
                }
                
                this.applySettings();
                return this.isConnected;
            }

            async loadFromBot() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/settings`, {
                        headers: {
                            'Authorization': userToken,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.settings = {...this.defaultSettings, ...data};
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–æ—Ç–∞');
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                    }
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –±–æ—Ç–∞:', error);
                    this.loadFromLocalStorage();
                }
            }

            async saveToBot() {
                if (!this.isConnected) {
                    this.saveToLocalStorage();
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/settings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': userToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.settings)
                    });

                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                    }
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–æ—Ç–∞');
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–æ—Ç–∞:', error);
                    this.saveToLocalStorage();
                }
            }

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('doomMazeSettings');
                    if (saved) {
                        this.settings = {...this.defaultSettings, ...JSON.parse(saved)};
                    }
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage');
                }
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('doomMazeSettings', JSON.stringify(this.settings));
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage');
                }
            }

            applySettings() {
                const musicSlider = document.getElementById('musicVolumeSlider');
                const soundSlider = document.getElementById('soundVolumeSlider');
                const sensitivitySlider = document.getElementById('sensitivitySlider');
                
                if (musicSlider) musicSlider.value = this.settings.musicVolume;
                if (soundSlider) soundSlider.value = this.settings.soundVolume;
                if (sensitivitySlider) sensitivitySlider.value = this.settings.sensitivity;
            }

            async updateSetting(key, value) {
                if (this.settings.hasOwnProperty(key)) {
                    this.settings[key] = value;
                    await this.saveToBot();
                    return true;
                }
                return false;
            }

            get musicVolume() { return this.settings.musicVolume; }
            get soundVolume() { return this.settings.soundVolume; }
            get sensitivity() { return this.settings.sensitivity; }
            
            set musicVolume(value) { this.updateSetting('musicVolume', value); }
            set soundVolume(value) { this.updateSetting('soundVolume', value); }
            set sensitivity(value) { this.updateSetting('sensitivity', value); }
        }

        // –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const settingsManager = new BotSettingsManager();

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–≥—Ä—ã (Three.js —Å—Ü–µ–Ω–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x87CEEB, 20, 50);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87CEEB);
        document.body.appendChild(renderer.domElement);

        // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–≥—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let yaw = 0;
        let pitch = 0;
        const PI_2 = Math.PI / 2;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        let mouseSensitivity = 0.002;
        let musicVolume = 0.5;
        let soundVolume = 0.5;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ
        function initAudio() {
            console.log('–ê—É–¥–∏–æ —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            musicVolume = settingsManager.musicVolume / 100;
            soundVolume = settingsManager.soundVolume / 100;
            mouseSensitivity = settingsManager.sensitivity * 0.0004;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é
        async function initMenu() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const isConnected = await settingsManager.initialize();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (isConnected) {
                console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –±–æ—Ç–æ–º');
            } else {
                console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            initAudio();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
            document.getElementById('sensitivitySlider').addEventListener('input', function(e) {
                const sensitivity = parseInt(e.target.value);
                mouseSensitivity = sensitivity * 0.0004;
                settingsManager.sensitivity = sensitivity;
            });

            document.getElementById('musicVolumeSlider').addEventListener('input', function(e) {
                const volume = parseInt(e.target.value);
                musicVolume = volume / 100;
                settingsManager.musicVolume = volume;
            });

            document.getElementById('soundVolumeSlider').addEventListener('input', function(e) {
                const volume = parseInt(e.target.value);
                soundVolume = volume / 100;
                settingsManager.soundVolume = volume;
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            document.getElementById('playButton').addEventListener('click', startGame);
            document.getElementById('optionsButton').addEventListener('click', showOptions);
            document.getElementById('backButton').addEventListener('click', hideOptions);
            
            console.log('–ú–µ–Ω—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã
        function startGame() {
            console.log('–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('optionsMenu').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –∏–≥—Ä—ã
            const fpsCounter = document.getElementById('fpsCounter');
            const uiPanel = document.getElementById('uiPanel');
            const weapon = document.getElementById('weapon');
            
            if (fpsCounter) fpsCounter.style.display = 'block';
            if (uiPanel) uiPanel.style.display = 'block';
            if (weapon) weapon.style.display = 'block';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            animate();
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function animate() {
            requestAnimationFrame(animate);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
            const direction = new THREE.Vector3();
            const moveSpeed = 0.2;
            
            if (moveForward) direction.z -= moveSpeed;
            if (moveBackward) direction.z += moveSpeed;
            if (moveLeft) direction.x -= moveSpeed;
            if (moveRight) direction.x += moveSpeed;
            
            direction.applyEuler(new THREE.Euler(0, yaw, 0));
            camera.position.add(direction);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—â–µ–Ω–∏—è
            camera.rotation.order = 'YXZ';
            camera.rotation.y = yaw;
            camera.rotation.x = pitch;
            
            renderer.render(scene, camera);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        function initControls() {
            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
            window.addEventListener('keydown', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    switch(event.code) {
                        case 'KeyW': moveForward = true; break;
                        case 'KeyS': moveBackward = true; break;
                        case 'KeyA': moveLeft = true; break;
                        case 'KeyD': moveRight = true; break;
                    }
                }
            });
            
            window.addEventListener('keyup', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    switch(event.code) {
                        case 'KeyW': moveForward = false; break;
                        case 'KeyS': moveBackward = false; break;
                        case 'KeyA': moveLeft = false; break;
                        case 'KeyD': moveRight = false; break;
                    }
                }
            });

            // –ú—ã—à—å
            document.addEventListener('mousemove', (event) => {
                if (document.getElementById('startMenu').style.display === 'none') {
                    yaw -= event.movementX * mouseSensitivity;
                    pitch -= event.movementY * mouseSensitivity;
                    pitch = Math.max(-PI_2, Math.min(PI_2, pitch));
                }
            });
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        async function initGame() {
            try {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Å—Ü–µ–Ω—É –¥–ª—è —Ç–µ—Å—Ç–∞
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                initControls();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω—é
                await initMenu();
                
                console.log('üéÆ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É!');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã:', error);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initGame();
    </script>
</body>
</html>
