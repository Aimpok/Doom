<!DOCTYPE html>
<html>
<head>
    <title>3D Лабиринт</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: #000;
        }
        canvas { 
            display: block; 
            touch-action: none;
        }
        
        /* Стартовое меню в стиле DOOM */
        #startMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .logo {
            width: 55vmin;
            max-width: 800px;
            position: absolute;
            top: 30%;
            transform: translateY(-50%);
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
            -webkit-touch-callout: none;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2.4vmin;
            position: absolute;
            top: 70%;
            transform: translateY(-50%);
        }
        
        .menu-button {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .menu-button:hover {
            transform: scale(1.05);
        }
        
        .menu-button:active {
            transform: scale(1.02);
        }
        
        .company-name {
            position: absolute;
            bottom: 0vmin;
            width: 28vmin;
            max-width: 300px;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
            opacity: 0.8;
            -webkit-touch-callout: none;
        }

        /* Панель настроек меню - СКРЫТА */
        .menu-settings {
            display: none;
        }

        /* Запрет выделения и контекстного меню для ВСЕХ элементов */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Экран настроек */
        #optionsMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            color: #fff;
        }
        
        .options-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 5vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
        
        .option-item {
            margin: 2vmin 0;
            font-size: 3vmin;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 1vmin 2vmin;
            border-radius: 5px;
            width: 80%;
            max-width: 400px;
        }
        
        .option-item label {
            display: flex;
            flex-direction: column;
            gap: 1vmin;
            width: 100%;
        }
        
        .back-button {
            margin-top: 5vmin;
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
            -webkit-touch-callout: none;
        }
        
        .back-button:hover {
            transform: scale(1.05);
        }
        
        /* Мобильное управление */
        #mobileControls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            display: none;
        }
        
        /* Джойстик для движения - УМЕНЬШЕН */
        #movementJoystick {
            position: absolute;
            bottom: 5vmin;
            left: 5vmin;
            width: 30vmin;
            height: 30vmin;
            pointer-events: auto;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: absolute;
        }
        
        .joystick-stick {
            width: 15vmin;
            height: 15vmin;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: absolute;
            top: 7.5vmin;
            left: 7.5vmin;
            transition: transform 0.1s;
        }
        
        /* Область для поворота камеры */
        #cameraTouchArea {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            pointer-events: auto;
        }

        /* Кнопка стрельбы - УМЕНЬШЕНА */
        #shootButton {
            position: absolute;
            bottom: 15vmin;
            right: 15vmin;
            width: 25vmin;
            height: 25vmin;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 5vmin;
            z-index: 60;
        }

        /* Оружие */
        #weapon {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40vmin;
            max-width: 400px;
            height: auto;
            pointer-events: none;
            z-index: 40;
            display: none;
        }

        /* Запрет перетаскивания для всех изображений */
        img {
            -webkit-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        /* Разрешаем pointer-events только для кликабельных кнопок */
        .menu-button {
            pointer-events: auto;
        }

        /* FPS счетчик */
        #fpsCounter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 3px;
            display: none;
            z-index: 1000;
        }

        /* UI панель с текстом */
        #uiPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
        }

        #hpDisplay, #ammoDisplay {
            margin-bottom: 10px;
            font-weight: bold;
        }

        #hpDisplay {
            color: #ff4444;
        }

        #ammoDisplay {
            color: #44ff44;
        }

        /* Эффект получения урона */
        #damageEffect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.3s;
            display: none;
        }

        /* Экран выбора режима игры */
        #modeSelectMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 120;
        }

        .mode-select-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 3vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        .mode-carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1200px;
            height: 60vmin;
            position: relative;
            overflow: hidden;
        }

        .mode-slide {
            position: absolute;
            width: 50vmin;
            height: 50vmin;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.5s ease;
            opacity: 0.5;
            transform: scale(0.8);
            cursor: pointer;
            background: rgba(40, 40, 40, 0.95);
            border: none;
            border-radius: 10px;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        .mode-slide.active {
            opacity: 1;
            transform: scale(1);
            z-index: 10;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
        }

        .mode-slide.left {
            transform: translateX(-80%) scale(0.7);
            cursor: pointer;
        }

        .mode-slide.right {
            transform: translateX(80%) scale(0.7);
            cursor: pointer;
        }

        .mode-icon {
            width: 100%;
            height: 70%;
            object-fit: cover;
            margin-bottom: 0;
            pointer-events: none;
            border-radius: 10px 10px 0 0;
        }

        .mode-name {
            width: 90%;
            max-width: 350px;
            object-fit: contain;
            pointer-events: none;
            margin: 1vmin 0;
            height: 15%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-description {
            color: white;
            font-size: 1.8vmin;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 1vmin;
            border-radius: 5px;
            width: 90%;
            pointer-events: none;
            margin-bottom: 1vmin;
            height: 15%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-nav {
            display: flex;
            gap: 3vmin;
            margin-top: 3vmin;
            align-items: center;
        }

        .nav-arrow {
            display: none;
        }

        .start-mode-button {
            width: 40vmin;
            max-width: 400px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
        }

        .start-mode-button:hover {
            transform: scale(1.05);
        }

        /* Дополнительные UI элементы для режимов */
        #modeStats {
            position: absolute;
            top: 50px;
            right: 20px;
            color: white;
            font-size: 20px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }

        #exitArea {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background: rgba(0, 255, 0, 0.3);
            border: 2px dashed rgba(0, 255, 0, 0.7);
            display: none;
            pointer-events: none;
            z-index: 30;
        }

        #waveInfo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        /* Стрелка для указания направления выхода */
        #exitArrow {
            position: absolute;
            top: 50%;
            right: 5%;
            width: 8vmin;
            height: 8vmin;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 45;
            display: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        /* Счетчик монет */
        #coinCounter {
            position: absolute;
            top: 10px;
            right: 10px;
            color: gold;
            font-size: 24px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background-image: url('GameUi/Coin/1.png');
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Меню оружия */
        #weaponsMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 130;
        }

        .weapons-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 3vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        .weapons-carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1200px;
            height: 60vmin;
            position: relative;
            overflow: hidden;
        }

        .weapon-slide {
            position: absolute;
            width: 50vmin;
            height: 50vmin;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.5s ease;
            opacity: 0.5;
            transform: scale(0.8);
            cursor: pointer;
            background: rgba(40, 40, 40, 0.95);
            border: none;
            border-radius: 10px;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        .weapon-slide.active {
            opacity: 1;
            transform: scale(1);
            z-index: 10;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
        }

        .weapon-slide.left {
            transform: translateX(-80%) scale(0.7);
            cursor: pointer;
        }

        .weapon-slide.right {
            transform: translateX(80%) scale(0.7);
            cursor: pointer;
        }

        .weapon-icon {
            width: 80%;
            height: 60%;
            object-fit: contain;
            margin-bottom: 0;
            pointer-events: none;
        }

        .weapon-name {
            width: 90%;
            max-width: 350px;
            object-fit: contain;
            pointer-events: none;
            margin: 1vmin 0;
            height: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weapon-description {
            color: white;
            font-size: 1.8vmin;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 1vmin;
            border-radius: 5px;
            width: 90%;
            pointer-events: none;
            margin-bottom: 1vmin;
            height: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weapon-price {
            color: gold;
            font-size: 2.5vmin;
            font-weight: bold;
            margin: 1vmin 0;
        }

        .weapon-button {
            width: 30vmin;
            max-width: 300px;
            min-width: 150px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
            margin-top: 1vmin;
        }

        .weapon-button:hover {
            transform: scale(1.05);
        }

        .back-icon {
            position: absolute;
            top: 3vmin;
            left: 3vmin;
            width: 8vmin;
            height: 8vmin;
            cursor: pointer;
            z-index: 140;
        }
    </style>
</head>
<body>
    
    <!-- Стартовое меню -->
    <div id="startMenu">
        <img src="MenuUi/Logo.png" alt="DOOM" class="logo">
        <div class="menu-buttons">
            <img src="MenuUi/PlayText.png" alt="Играть" class="menu-button" id="playButton">
            <img src="MenuUi/GunsText.png" alt="Оружия" class="menu-button" id="weaponsButton">
            <img src="MenuUi/OptionsText.png" alt="Настройки" class="menu-button" id="optionsButton">
        </div>
        <img src="MenuUi/companyname.png" alt="Company Name" class="company-name">
    </div>
    
    <!-- Меню выбора режима -->
    <div id="modeSelectMenu">
        <img src="MenuUi/SelectModeText.png" alt="ВЫБОР РЕЖИМА" class="mode-select-title">
        
        <div class="mode-carousel">
            <div class="mode-slide" data-mode="extermination">
                <img src="MenuUi/ModeIcons/ExterminationProtocol.png" alt="Extermination Protocol" class="mode-icon">
                <img src="MenuUi/ExterminationProtocolText.png" alt="EXTERMINATION PROTOCOL" class="mode-name">
                <div class="mode-description">Убей 20 врагов</div>
            </div>
            
            <div class="mode-slide" data-mode="straight">
                <img src="MenuUi/ModeIcons/StraightThrough.png" alt="Straight Through" class="mode-icon">
                <img src="MenuUi/StraightThroughText.png" alt="STRAIGHT THROUGH" class="mode-name">
                <div class="mode-description">Найди выход</div>
            </div>
            
            <div class="mode-slide" data-mode="onslaught">
                <img src="MenuUi/ModeIcons/Onslaught.png" alt="Onslaught" class="mode-icon">
                <img src="MenuUi/OnslaughtText.png" alt="ONSLAUGHT" class="mode-name">
                <div class="mode-description">Выживи как можно дольше</div>
            </div>
        </div>
        
        <div class="carousel-nav">
            <img src="MenuUi/PlayText.png" alt="Играть" class="start-mode-button" id="startModeButton">
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backToMainButton">
    </div>

    <!-- Меню оружия -->
    <div id="weaponsMenu">
        <img src="MenuUi/BackIcon.png" alt="НАЗАД" class="back-icon" id="backFromWeapons">
        <img src="MenuUi/GunsText.png" alt="ОРУЖИЯ" class="weapons-title">
        
        <div class="weapons-carousel">
            <div class="weapon-slide" data-weapon="default">
                <img src="Guns/DefaultShootGun/Gun.png" alt="Одностволка" class="weapon-icon">
                <img src="MenuUi/SingleShootgunText.png" alt="ОДНОСТВОЛКА" class="weapon-name">
                <div class="weapon-description">Стандартное оружие</div>
                <div class="weapon-price">БЕСПЛАТНО</div>
                <img src="MenuUi/SelectedText.png" alt="ВЫБРАНО" class="weapon-button" id="selectDefaultWeapon">
            </div>
            
            <div class="weapon-slide" data-weapon="double">
                <img src="Guns/DoubleShootGun/Gun.png" alt="Двухстволка" class="weapon-icon">
                <img src="MenuUi/DoubleShootgunText.png" alt="ДВУХСТВОЛКА" class="weapon-name">
                <div class="weapon-description">Мощное оружие с 2 патронами</div>
                <div class="weapon-price" id="doubleGunPrice">100 МОНЕТ</div>
                <img src="MenuUi/BuyText.png" alt="КУПИТЬ" class="weapon-button" id="buyDoubleWeapon" style="display: none;">
                <img src="MenuUi/SelectText.png" alt="ВЫБРАТЬ" class="weapon-button" id="selectDoubleWeapon" style="display: none;">
            </div>
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backToMainFromWeapons">
    </div>
    
    <!-- Панель настроек меню - СКРЫТА -->
    <div class="menu-settings">
        <!-- Скрыто -->
    </div>
    
    <!-- Меню настроек -->
    <div id="optionsMenu">
        <img src="MenuUi/OptionsText.png" alt="НАСТРОЙКИ" class="options-title">
        
        <div class="option-item">
            <label>
                Громкость музыки: 
                <input type="range" id="musicVolumeSlider" min="0" max="100" value="50">
            </label>
        </div>
        
        <div class="option-item">
            <label>
                Громкость звуков: 
                <input type="range" id="soundVolumeSlider" min="0" max="100" value="50">
            </label>
        </div>
        
        <div class="option-item">
            <label>
                Чувствительность: 
                <input type="range" id="sensitivitySlider" min="1" max="10" value="5">
            </label>
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backButton">
    </div>
    
    <!-- Мобильное управление -->
    <div id="mobileControls">
        <div id="movementJoystick">
            <div class="joystick-base"></div>
            <div class="joystick-stick" id="joystickStick"></div>
        </div>
        
        <!-- Область для поворота камеры -->
        <div id="cameraTouchArea"></div>
        
        <!-- Кнопка стрельбы -->
        <div id="shootButton">FIRE</div>
    </div>
    
    <!-- Оружие -->
    <img id="weapon" src="Guns/DefaultShootGun/Gun.png" alt="Weapon">
    
    <!-- UI Панель с текстом -->
    <div id="uiPanel">
        <div id="hpDisplay">HP: 100</div>
        <div id="ammoDisplay">ПАТРОНЫ: 2/2</div>
    </div>
    
    <!-- Дополнительная статистика для режимов -->
    <div id="modeStats">
        <div id="enemiesKilled">Убито: 0/20</div>
        <div id="waveCounter">Волна: 1</div>
    </div>
    
    <!-- Счетчик монет -->
    <div id="coinCounter">
        <div class="coin-icon"></div>
        <span id="coinsCount">0</span>
    </div>
    
    <!-- Область выхода для режима Straight Through -->
    <div id="exitArea"></div>
    
    <!-- Информация о волне -->
    <div id="waveInfo"></div>
    
    <!-- Стрелка для указания направления выхода -->
    <img id="exitArrow" src="MenuUi/ArrowIcon.png" alt="→">
    
    <!-- Эффект получения урона -->
    <div id="damageEffect"></div>
    
    <!-- FPS счетчик -->
    <div id="fpsCounter">FPS: 0</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Инициализация меню
        function initMenu() {
            const playButton = document.getElementById('playButton');
            const weaponsButton = document.getElementById('weaponsButton');
            const optionsButton = document.getElementById('optionsButton');
            const backButton = document.getElementById('backButton');
            const backToMainButton = document.getElementById('backToMainButton');
            const backFromWeapons = document.getElementById('backFromWeapons');
            const backToMainFromWeapons = document.getElementById('backToMainFromWeapons');
            
            // Устанавливаем начальные значения слайдеров из сохраненных настроек
            document.getElementById('musicVolumeSlider').value = settingsManager.musicVolume;
            document.getElementById('soundVolumeSlider').value = settingsManager.soundVolume;
            document.getElementById('sensitivitySlider').value = settingsManager.sensitivity;
            
            // Инициализируем меню оружия
            initWeaponsMenu();
            
            // Запускаем музыку при инициализации
            startMusic();
            
            // Добавляем обработчики для принудительного запуска музыки
            document.addEventListener('click', startMusicOnInteraction, { once: true });
            document.addEventListener('touchstart', startMusicOnInteraction, { once: true });
            
            playButton.addEventListener('click', function(e) {
                showModeSelect();
            });
            
            weaponsButton.addEventListener('click', function(e) {
                showWeaponsMenu();
            });
            
            optionsButton.addEventListener('click', function(e) {
                showOptions();
            });
            
            backButton.addEventListener('click', function(e) {
                hideOptions();
            });
            
            backToMainButton.addEventListener('click', function(e) {
                hideModeSelect();
            });
            
            backFromWeapons.addEventListener('click', function(e) {
                hideWeaponsMenu();
            });
            
            backToMainFromWeapons.addEventListener('click', function(e) {
                hideWeaponsMenu();
            });
            
            // Инициализируем карусель режимов
            initModeCarousel();
        }

        // Функции для меню
        function showModeSelect() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('modeSelectMenu').style.display = 'flex';
        }

        function showWeaponsMenu() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('weaponsMenu').style.display = 'flex';
            updateWeaponsMenu();
        }

        function showOptions() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('optionsMenu').style.display = 'flex';
            
            // Устанавливаем значения слайдеров из сохраненных настроек
            document.getElementById('musicVolumeSlider').value = settingsManager.musicVolume;
            document.getElementById('soundVolumeSlider').value = settingsManager.soundVolume;
            document.getElementById('sensitivitySlider').value = settingsManager.sensitivity;
        }

        function hideOptions() {
            document.getElementById('optionsMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        function hideModeSelect() {
            document.getElementById('modeSelectMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        function hideWeaponsMenu() {
            document.getElementById('weaponsMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        // Инициализация карусели режимов
        function initModeCarousel() {
            const slides = document.querySelectorAll('.mode-slide');
            const startBtn = document.getElementById('startModeButton');
            
            let currentSlide = 0;
            
            // Устанавливаем начальный активный слайд
            updateSlides();
            
            // Обработчики для кликов по слайдам
            slides.forEach((slide, index) => {
                slide.addEventListener('click', (e) => {
                    // Если клик по левому слайду - перейти к предыдущему
                    if (slide.classList.contains('left')) {
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        updateSlides();
                    }
                    // Если клик по правому слайду - перейти к следующему
                    else if (slide.classList.contains('right')) {
                        currentSlide = (currentSlide + 1) % slides.length;
                        updateSlides();
                    }
                    // Если клик по активному слайду - ничего не делаем (можно выбрать режим)
                });
            });
            
            // Обработчик для кнопки старта
            startBtn.addEventListener('click', () => {
                const activeSlide = document.querySelector('.mode-slide.active');
                const mode = activeSlide.getAttribute('data-mode');
                selectGameMode(mode);
            });
            
            // Функция обновления слайдов
            function updateSlides() {
                slides.forEach((slide, index) => {
                    slide.classList.remove('active', 'left', 'right');
                    
                    if (index === currentSlide) {
                        slide.classList.add('active');
                    } else if (index === (currentSlide - 1 + slides.length) % slides.length) {
                        slide.classList.add('left');
                    } else if (index === (currentSlide + 1) % slides.length) {
                        slide.classList.add('right');
                    }
                });
            }
            
            // Добавляем поддержку свайпов
            let touchStartX = 0;
            let touchEndX = 0;
            
            const carousel = document.querySelector('.mode-carousel');
            
            carousel.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            carousel.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Свайп влево - следующий слайд
                    currentSlide = (currentSlide + 1) % slides.length;
                    updateSlides();
                } else if (touchEndX > touchStartX + swipeThreshold) {
                    // Свайп вправо - предыдущий слайд
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                    updateSlides();
                }
            }
        }

        // Инициализация меню оружия
        function initWeaponsMenu() {
            const slides = document.querySelectorAll('.weapon-slide');
            let currentSlide = 0;
            
            // Устанавливаем начальный активный слайд
            updateWeaponSlides();
            
            // Обработчики для кликов по слайдам
            slides.forEach((slide, index) => {
                slide.addEventListener('click', (e) => {
                    // Если клик по левому слайду - перейти к предыдущему
                    if (slide.classList.contains('left')) {
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        updateWeaponSlides();
                    }
                    // Если клик по правому слайду - перейти к следующему
                    else if (slide.classList.contains('right')) {
                        currentSlide = (currentSlide + 1) % slides.length;
                        updateWeaponSlides();
                    }
                });
            });
            
            // Обработчики для кнопок оружия
            document.getElementById('selectDefaultWeapon').addEventListener('click', function() {
                selectWeapon('default');
            });
            
            document.getElementById('buyDoubleWeapon').addEventListener('click', function() {
                buyWeapon('double');
            });
            
            document.getElementById('selectDoubleWeapon').addEventListener('click', function() {
                selectWeapon('double');
            });
            
            // Функция обновления слайдов оружия
            function updateWeaponSlides() {
                slides.forEach((slide, index) => {
                    slide.classList.remove('active', 'left', 'right');
                    
                    if (index === currentSlide) {
                        slide.classList.add('active');
                    } else if (index === (currentSlide - 1 + slides.length) % slides.length) {
                        slide.classList.add('left');
                    } else if (index === (currentSlide + 1) % slides.length) {
                        slide.classList.add('right');
                    }
                });
            }
            
            // Добавляем поддержку свайпов
            let touchStartX = 0;
            let touchEndX = 0;
            
            const carousel = document.querySelector('.weapons-carousel');
            
            carousel.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            carousel.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Свайп влево - следующий слайд
                    currentSlide = (currentSlide + 1) % slides.length;
                    updateWeaponSlides();
                } else if (touchEndX > touchStartX + swipeThreshold) {
                    // Свайп вправо - предыдущий слайд
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                    updateWeaponSlides();
                }
            }
        }

        // Обновление меню оружия
        function updateWeaponsMenu() {
            const doubleWeaponPurchased = settingsManager.getSetting('doubleWeaponPurchased') || false;
            const currentWeapon = settingsManager.getSetting('currentWeapon') || 'default';
            
            const buyButton = document.getElementById('buyDoubleWeapon');
            const selectButton = document.getElementById('selectDoubleWeapon');
            const priceElement = document.getElementById('doubleGunPrice');
            
            if (doubleWeaponPurchased) {
                buyButton.style.display = 'none';
                selectButton.style.display = 'block';
                priceElement.textContent = 'КУПЛЕНО';
                priceElement.style.color = '#00ff00';
            } else {
                buyButton.style.display = 'block';
                selectButton.style.display = 'none';
                priceElement.textContent = '100 МОНЕТ';
                priceElement.style.color = 'gold';
            }
            
            // Обновляем кнопки выбора
            document.getElementById('selectDefaultWeapon').src = currentWeapon === 'default' ? 
                'MenuUi/SelectedText.png' : 'MenuUi/SelectText.png';
                
            if (doubleWeaponPurchased) {
                document.getElementById('selectDoubleWeapon').src = currentWeapon === 'double' ? 
                    'MenuUi/SelectedText.png' : 'MenuUi/SelectText.png';
            }
        }

        // Покупка оружия
        function buyWeapon(weaponType) {
            if (weaponType === 'double') {
                const coins = settingsManager.getCoins();
                if (coins >= 100) {
                    settingsManager.addCoins(-100);
                    settingsManager.updateSetting('doubleWeaponPurchased', true);
                    settingsManager.updateSetting('currentWeapon', 'double');
                    updateWeaponsMenu();
                    updateCoinCounter();
                    applyWeaponSettings('double');
                } else {
                    alert('Недостаточно монет! Нужно 100 монет.');
                }
            }
        }

        // Выбор оружия
        function selectWeapon(weaponType) {
            if (weaponType === 'double') {
                const doubleWeaponPurchased = settingsManager.getSetting('doubleWeaponPurchased') || false;
                if (!doubleWeaponPurchased) {
                    alert('Сначала купите это оружие!');
                    return;
                }
            }
            
            settingsManager.updateSetting('currentWeapon', weaponType);
            updateWeaponsMenu();
            applyWeaponSettings(weaponType);
        }

        // Применение настроек оружия
        function applyWeaponSettings(weaponType) {
            if (weaponType === 'default') {
                maxAmmo = 2;
                gunImages = {
                    normal: 'Guns/DefaultShootGun/Gun.png',
                    shoot1: 'Guns/DefaultShootGun/GunSh1.png',
                    shoot2: 'Guns/DefaultShootGun/GunSh2.png',
                    reload1: 'Guns/DefaultShootGun/GunKD1.png',
                    reload2: 'Guns/DefaultShootGun/GunKD2.png',
                    reload3: 'Guns/DefaultShootGun/GunKD3.png'
                };
            } else if (weaponType === 'double') {
                maxAmmo = 2;
                gunImages = {
                    normal: 'Guns/DoubleShootGun/Gun.png',
                    shoot1: 'Guns/DoubleShootGun/GunSh1.png',
                    shoot2: 'Guns/DoubleShootGun/GunSh2.png',
                    reload1: 'Guns/DoubleShootGun/GunKD1.png',
                    reload2: 'Guns/DoubleShootGun/GunKD2.png',
                    reload3: 'Guns/DoubleShootGun/GunKD3.png'
                };
            }
            
            ammo = maxAmmo;
            updateUI();
            
            if (weapon.style.display !== 'none') {
                weapon.src = gunImages.normal;
            }
        }

        // Функция выбора режима игры
        function selectGameMode(mode) {
            currentGameMode = mode;
            
            // Создаем лабиринт в зависимости от режима
            mazeGen = new MazeGenerator(25, 25, mode);
            maze = mazeGen.getMaze();
            
            // Создаем систему навигации
            navigationSystem = new NavigationSystem();
            
            // Устанавливаем стартовую позицию
            if (mode === 'straight') {
                startPos = findCornerStartPosition();
            } else {
                startPos = findRandomStartPosition();
            }
            
            camera.position.set(startPos.x, 1.7, startPos.z);
            
            // Пересоздаем сцену
            const materials = createMaterials();
            createScene(materials);
            
            // Запускаем игру
            startGame();
        }

        // ЖЕСТКИЙ ЗАПРЕТ КОНТЕКСТНОГО МЕНЮ И ПЕРЕТАСКИВАНИЯ
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Настройки
        document.getElementById('sensitivitySlider').addEventListener('input', function(e) {
            const sensitivity = parseInt(e.target.value);
            mouseSensitivity = sensitivity * 0.0004;
            settingsManager.updateSetting('sensitivity', sensitivity);
        });

        document.getElementById('musicVolumeSlider').addEventListener('input', function(e) {
            const volume = parseInt(e.target.value);
            musicVolume = volume / 100;
            settingsManager.updateSetting('musicVolume', volume);
            updateVolumes();
        });

        document.getElementById('soundVolumeSlider').addEventListener('input', function(e) {
            const volume = parseInt(e.target.value);
            soundVolume = volume / 100;
            settingsManager.updateSetting('soundVolume', volume);
            updateVolumes();
        });

        // Запуск игры после загрузки
        window.addEventListener('load', function() {
            loadTextures().then(() => {
                // Создаем начальный лабиринт (будет пересоздан при выборе режима)
                mazeGen = new MazeGenerator(25, 25);
                maze = mazeGen.getMaze();
                navigationSystem = new NavigationSystem();
                
                const materials = createMaterials();
                createScene(materials);
                initAudio();
                initControls();
                initMenu();
                weapon.style.display = 'none';
                
                // Применяем сохраненное оружие
                const savedWeapon = settingsManager.getSetting('currentWeapon') || 'default';
                applyWeaponSettings(savedWeapon);
                
                preloadWeaponImages();
            }).catch((error) => {
                console.error('Ошибка загрузки:', error);
                // Создаем начальный лабиринт (будет пересоздан при выборе режима)
                mazeGen = new MazeGenerator(25, 25);
                maze = mazeGen.getMaze();
                navigationSystem = new NavigationSystem();
                
                const materials = createMaterials();
                createScene(materials);
                initAudio();
                initControls();
                initMenu();
                weapon.style.display = 'none';
                
                // Применяем сохраненное оружие
                const savedWeapon = settingsManager.getSetting('currentWeapon') || 'default';
                applyWeaponSettings(savedWeapon);
                
                preloadWeaponImages();
            });
        });
    </script>
</body>
</html>
