<!DOCTYPE html>
<html>
<head>
    <title>3D Лабиринт</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: #000;
        }
        canvas { 
            display: block; 
            touch-action: none;
        }
        
        /* Стартовое меню в стиле DOOM */
        #startMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .logo {
            width: 55vmin;
            max-width: 800px;
            position: absolute;
            top: 30%;
            transform: translateY(-50%);
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
            -webkit-touch-callout: none;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2.4vmin;
            position: absolute;
            top: 70%;
            transform: translateY(-50%);
        }
        
        .menu-button {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .menu-button:hover {
            transform: scale(1.05);
        }
        
        .menu-button:active {
            transform: scale(1.02);
        }
        
        .company-name {
            position: absolute;
            bottom: 0vmin;
            width: 28vmin;
            max-width: 300px;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
            opacity: 0.8;
            -webkit-touch-callout: none;
        }

        /* Панель настроек меню - СКРЫТА */
        .menu-settings {
            display: none;
        }

        /* Запрет выделения и контекстного меню для ВСЕХ элементов */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Экран настроек */
        #optionsMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            color: #fff;
        }
        
        .options-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 5vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
        
        .option-item {
            margin: 2vmin 0;
            font-size: 3vmin;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 1vmin 2vmin;
            border-radius: 5px;
            width: 80%;
            max-width: 400px;
        }
        
        .option-item label {
            display: flex;
            flex-direction: column;
            gap: 1vmin;
            width: 100%;
        }
        
        .back-button {
            margin-top: 5vmin;
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
            -webkit-touch-callout: none;
        }
        
        .back-button:hover {
            transform: scale(1.05);
        }
        
        /* Мобильное управление */
        #mobileControls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            display: none;
        }
        
        /* Джойстик для движения - УМЕНЬШЕН */
        #movementJoystick {
            position: absolute;
            bottom: 5vmin;
            left: 5vmin;
            width: 30vmin;
            height: 30vmin;
            pointer-events: auto;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: absolute;
        }
        
        .joystick-stick {
            width: 15vmin;
            height: 15vmin;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: absolute;
            top: 7.5vmin;
            left: 7.5vmin;
            transition: transform 0.1s;
        }
        
        /* Область для поворота камеры */
        #cameraTouchArea {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            pointer-events: auto;
        }

        /* Кнопка стрельбы - УМЕНЬШЕНА */
        #shootButton {
            position: absolute;
            bottom: 15vmin;
            right: 15vmin;
            width: 25vmin;
            height: 25vmin;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 5vmin;
            z-index: 60;
        }

        /* Оружие */
        #weapon {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40vmin;
            max-width: 400px;
            height: auto;
            pointer-events: none;
            z-index: 40;
            display: none;
        }

        /* Запрет перетаскивания для всех изображений */
        img {
            -webkit-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        /* Разрешаем pointer-events только для кликабельных кнопок */
        .menu-button {
            pointer-events: auto;
        }

        /* FPS счетчик */
        #fpsCounter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 3px;
            display: none;
            z-index: 1000;
        }

        /* UI панель с текстом */
        #uiPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
        }

        #hpDisplay, #ammoDisplay {
            margin-bottom: 10px;
            font-weight: bold;
        }

        #hpDisplay {
            color: #ff4444;
        }

        #ammoDisplay {
            color: #44ff44;
        }

        /* Эффект получения урона */
        #damageEffect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.3s;
            display: none;
        }

        /* Экран выбора режима игры */
        #modeSelectMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 120;
        }

        .mode-select-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 3vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        .mode-carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1200px;
            height: 60vmin;
            position: relative;
            overflow: hidden;
        }

        .mode-slide {
            position: absolute;
            width: 50vmin; /* Уменьшил ширину рамки */
            height: 50vmin;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Изменил на flex-start */
            transition: all 0.5s ease;
            opacity: 0.5;
            transform: scale(0.8);
            cursor: pointer;
            background: rgba(40, 40, 40, 0.95); /* Убрал прозрачность, сделал нормальный цвет */
            border: none; /* Убрал обводку */
            border-radius: 10px;
            padding: 0; /* Убрал внутренние отступы */
            box-sizing: border-box;
            overflow: hidden;
        }

        .mode-slide.active {
            opacity: 1;
            transform: scale(1);
            z-index: 10;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
        }

        .mode-slide.left {
            transform: translateX(-80%) scale(0.7);
            cursor: pointer;
        }

        .mode-slide.right {
            transform: translateX(80%) scale(0.7);
            cursor: pointer;
        }

        .mode-icon {
            width: 100%; /* Растягиваем на всю ширину рамки */
            height: 70%; /* Занимает 70% высоты */
            object-fit: cover; /* Растягиваем изображение чтобы заполнить всю область */
            margin-bottom: 0;
            pointer-events: none;
            border-radius: 10px 10px 0 0; /* Закругляем только верхние углы */
        }

        .mode-name {
            width: 90%; /* Уменьшил ширину чтобы было поуже */
            max-width: 350px;
            object-fit: contain;
            pointer-events: none;
            margin: 1vmin 0; /* Уменьшил отступы */
            height: 15%; /* Фиксируем высоту для названия */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-description {
            color: white;
            font-size: 1.8vmin;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 1vmin;
            border-radius: 5px;
            width: 90%;
            pointer-events: none;
            margin-bottom: 1vmin;
            height: 15%; /* Фиксируем высоту для описания */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-nav {
            display: flex;
            gap: 3vmin;
            margin-top: 3vmin;
            align-items: center;
        }

        .nav-arrow {
            display: none; /* Скрываем стрелки навигации */
        }

        .start-mode-button {
            width: 40vmin;
            max-width: 400px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
        }

        .start-mode-button:hover {
            transform: scale(1.05);
        }

        /* Дополнительные UI элементы для режимов */
        #modeStats {
            position: absolute;
            top: 50px;
            right: 20px;
            color: white;
            font-size: 20px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }

        #exitArea {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background: rgba(0, 255, 0, 0.3);
            border: 2px dashed rgba(0, 255, 0, 0.7);
            display: none;
            pointer-events: none;
            z-index: 30;
        }

        #waveInfo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        /* Стрелка для указания направления выхода */
        #exitArrow {
            position: absolute;
            top: 50%;
            right: 5%;
            width: 8vmin;
            height: 8vmin;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 45;
            display: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        /* Счетчик монет */
        #coinCounter {
            position: absolute;
            top: 10px;
            right: 10px;
            color: gold;
            font-size: 24px;
            font-family: 'Arial', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 45;
            display: none;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background-image: url('GameUi/Coin/1.png');
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Магазин оружия */
        #weaponsMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('MenuUi/MenuBg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 130;
        }

        .weapons-title {
            width: 60vmin;
            max-width: 600px;
            min-width: 250px;
            margin-bottom: 3vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        .weapons-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2vmin;
            width: 90%;
            max-width: 800px;
            height: 60vmin;
            overflow-y: auto;
            padding: 2vmin;
        }

        .weapon-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: rgba(40, 40, 40, 0.9);
            padding: 2vmin;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 15vmin;
        }

        .weapon-item:hover {
            background: rgba(60, 60, 60, 0.9);
            transform: scale(1.02);
        }

        .weapon-info {
            display: flex;
            align-items: center;
            gap: 2vmin;
            flex: 1;
        }

        .weapon-image {
            width: 12vmin;
            height: 12vmin;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
        }

        .weapon-details {
            display: flex;
            flex-direction: column;
            gap: 0.5vmin;
        }

        .weapon-name {
            color: white;
            font-size: 3vmin;
            font-weight: bold;
        }

        .weapon-description {
            color: #ccc;
            font-size: 2vmin;
        }

        .weapon-price {
            color: gold;
            font-size: 2.5vmin;
            font-weight: bold;
        }

        .weapon-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1vmin;
        }

        .weapon-action-button {
            width: 20vmin;
            max-width: 200px;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: contain;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
        }

        .weapon-action-button:hover {
            transform: scale(1.05);
        }

        .back-icon {
            position: absolute;
            top: 2vmin;
            left: 2vmin;
            width: 8vmin;
            height: 8vmin;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: auto;
        }

        .back-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    
    <!-- Стартовое меню -->
    <div id="startMenu">
        <img src="MenuUi/Logo.png" alt="DOOM" class="logo">
        <div class="menu-buttons">
            <img src="MenuUi/PlayText.png" alt="Играть" class="menu-button" id="playButton">
            <img src="MenuUi/WeaponsText.png" alt="Оружия" class="menu-button" id="weaponsButton">
            <img src="MenuUi/OptionsText.png" alt="Настройки" class="menu-button" id="optionsButton">
        </div>
        <img src="MenuUi/companyname.png" alt="Company Name" class="company-name">
    </div>
    
    <!-- Меню выбора режима -->
    <div id="modeSelectMenu">
        <img src="MenuUi/SelectModeText.png" alt="ВЫБОР РЕЖИМА" class="mode-select-title">
        
        <div class="mode-carousel">
            <div class="mode-slide" data-mode="extermination">
                <img src="MenuUi/ModeIcons/ExterminationProtocol.png" alt="Extermination Protocol" class="mode-icon">
                <img src="MenuUi/ExterminationProtocolText.png" alt="EXTERMINATION PROTOCOL" class="mode-name">
                <div class="mode-description">Убей 20 врагов</div>
            </div>
            
            <div class="mode-slide" data-mode="straight">
                <img src="MenuUi/ModeIcons/StraightThrough.png" alt="Straight Through" class="mode-icon">
                <img src="MenuUi/StraightThroughText.png" alt="STRAIGHT THROUGH" class="mode-name">
                <div class="mode-description">Найди выход</div>
            </div>
            
            <div class="mode-slide" data-mode="onslaught">
                <img src="MenuUi/ModeIcons/Onslaught.png" alt="Onslaught" class="mode-icon">
                <img src="MenuUi/OnslaughtText.png" alt="ONSLAUGHT" class="mode-name">
                <div class="mode-description">Выживи как можно дольше</div>
            </div>
        </div>
        
        <div class="carousel-nav">
            <img src="MenuUi/PlayText.png" alt="Играть" class="start-mode-button" id="startModeButton">
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backToMainButton">
    </div>

    <!-- Магазин оружия -->
    <div id="weaponsMenu">
        <img src="MenuUi/WeaponsText.png" alt="ОРУЖИЯ" class="weapons-title">
        
        <div class="weapons-list">
            <!-- Оружие 1: Стандартное (уже куплено) -->
            <div class="weapon-item" data-weapon="default">
                <div class="weapon-info">
                    <img src="Guns/DefaultShootGun/Gun.png" alt="Дробовик" class="weapon-image">
                    <div class="weapon-details">
                        <div class="weapon-name">ДРОБОВИК</div>
                        <div class="weapon-description">2 патрона, средняя перезарядка</div>
                        <div class="weapon-price">БЕСПЛАТНО</div>
                    </div>
                </div>
                <div class="weapon-actions">
                    <img src="MenuUi/SelectedText.png" alt="ВЫБРАНО" class="weapon-action-button selected-button" style="display: none;">
                    <img src="MenuUi/SelectText.png" alt="ВЫБРАТЬ" class="weapon-action-button select-button">
                </div>
            </div>
            
            <!-- Оружие 2: Одноствольное (покупается) -->
            <div class="weapon-item" data-weapon="single">
                <div class="weapon-info">
                    <img src="Guns/SingleShootGun/Gun.png" alt="Одностволка" class="weapon-image">
                    <div class="weapon-details">
                        <div class="weapon-name">ОДНОСТВОЛКА</div>
                        <div class="weapon-description">1 патрон, быстрая перезарядка</div>
                        <div class="weapon-price">100 МОНЕТ</div>
                    </div>
                </div>
                <div class="weapon-actions">
                    <img src="MenuUi/SelectedText.png" alt="ВЫБРАНО" class="weapon-action-button selected-button" style="display: none;">
                    <img src="MenuUi/BuyText.png" alt="КУПИТЬ" class="weapon-action-button buy-button">
                    <img src="MenuUi/SelectText.png" alt="ВЫБРАТЬ" class="weapon-action-button select-button" style="display: none;">
                </div>
            </div>
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backFromWeaponsButton">
        <img src="MenuUi/BackIcon.png" alt="←" class="back-icon" id="backIconWeapons">
    </div>
    
    <!-- Панель настроек меню - СКРЫТА -->
    <div class="menu-settings">
        <!-- Скрыто -->
    </div>
    
    <!-- Меню настроек -->
    <div id="optionsMenu">
        <img src="MenuUi/OptionsText.png" alt="НАСТРОЙКИ" class="options-title">
        
        <div class="option-item">
            <label>
                Громкость музыки: 
                <input type="range" id="musicVolumeSlider" min="0" max="100" value="50">
            </label>
        </div>
        
        <div class="option-item">
            <label>
                Громкость звуков: 
                <input type="range" id="soundVolumeSlider" min="0" max="100" value="50">
            </label>
        </div>
        
        <div class="option-item">
            <label>
                Чувствительность: 
                <input type="range" id="sensitivitySlider" min="1" max="10" value="5">
            </label>
        </div>
        
        <img src="MenuUi/BackText.png" alt="НАЗАД" class="back-button" id="backButton">
    </div>
    
    <!-- Мобильное управление -->
    <div id="mobileControls">
        <div id="movementJoystick">
            <div class="joystick-base"></div>
            <div class="joystick-stick" id="joystickStick"></div>
        </div>
        
        <!-- Область для поворота камеры -->
        <div id="cameraTouchArea"></div>
        
        <!-- Кнопка стрельбы -->
        <div id="shootButton">FIRE</div>
    </div>
    
    <!-- Оружие -->
    <img id="weapon" src="Guns/DefaultShootGun/Gun.png" alt="Weapon">
    
    <!-- UI Панель с текстом -->
    <div id="uiPanel">
        <div id="hpDisplay">HP: 100</div>
        <div id="ammoDisplay">ПАТРОНЫ: 2/2</div>
    </div>
    
    <!-- Дополнительная статистика для режимов -->
    <div id="modeStats">
        <div id="enemiesKilled">Убито: 0/20</div>
        <div id="waveCounter">Волна: 1</div>
    </div>
    
    <!-- Счетчик монет -->
    <div id="coinCounter">
        <div class="coin-icon"></div>
        <span id="coinsCount">0</span>
    </div>
    
    <!-- Область выхода для режима Straight Through -->
    <div id="exitArea"></div>
    
    <!-- Информация о волне -->
    <div id="waveInfo"></div>
    
    <!-- Стрелка для указания выхода -->
    <img id="exitArrow" src="MenuUi/ArrowIcon.png" alt="→">
    
    <!-- Эффект получения урона -->
    <div id="damageEffect"></div>
    
    <!-- FPS счетчик -->
    <div id="fpsCounter">FPS: 0</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Инициализация меню
        function initMenu() {
            const playButton = document.getElementById('playButton');
            const weaponsButton = document.getElementById('weaponsButton');
            const optionsButton = document.getElementById('optionsButton');
            const backButton = document.getElementById('backButton');
            const backToMainButton = document.getElementById('backToMainButton');
            const backFromWeaponsButton = document.getElementById('backFromWeaponsButton');
            const backIconWeapons = document.getElementById('backIconWeapons');
            
            // Устанавливаем начальные значения слайдеров из сохраненных настроек
            document.getElementById('musicVolumeSlider').value = settingsManager.musicVolume;
            document.getElementById('soundVolumeSlider').value = settingsManager.soundVolume;
            document.getElementById('sensitivitySlider').value = settingsManager.sensitivity;
            
            // Запускаем музыку при инициализации
            startMusic();
            
            // Добавляем обработчики для принудительного запуска музыки
            document.addEventListener('click', startMusicOnInteraction, { once: true });
            document.addEventListener('touchstart', startMusicOnInteraction, { once: true });
            
            playButton.addEventListener('click', function(e) {
                showModeSelect();
            });
            
            weaponsButton.addEventListener('click', function(e) {
                showWeaponsMenu();
            });
            
            optionsButton.addEventListener('click', function(e) {
                showOptions();
            });
            
            backButton.addEventListener('click', function(e) {
                hideOptions();
            });
            
            backToMainButton.addEventListener('click', function(e) {
                hideModeSelect();
            });
            
            backFromWeaponsButton.addEventListener('click', function(e) {
                hideWeaponsMenu();
            });
            
            backIconWeapons.addEventListener('click', function(e) {
                hideWeaponsMenu();
            });
            
            // Инициализируем карусель режимов
            initModeCarousel();
            
            // Инициализируем магазин оружия
            initWeaponsMenu();
        }

        // Функции для меню
        function showModeSelect() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('modeSelectMenu').style.display = 'flex';
        }

        function showWeaponsMenu() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('weaponsMenu').style.display = 'flex';
            updateWeaponsMenu();
        }

        function hideWeaponsMenu() {
            document.getElementById('weaponsMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        function showOptions() {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById('optionsMenu').style.display = 'flex';
            
            // Устанавливаем значения слайдеров из сохраненных настроек
            document.getElementById('musicVolumeSlider').value = settingsManager.musicVolume;
            document.getElementById('soundVolumeSlider').value = settingsManager.soundVolume;
            document.getElementById('sensitivitySlider').value = settingsManager.sensitivity;
        }

        function hideOptions() {
            document.getElementById('optionsMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        function hideModeSelect() {
            document.getElementById('modeSelectMenu').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
        }

        // Инициализация карусели режимов
        function initModeCarousel() {
            const slides = document.querySelectorAll('.mode-slide');
            const startBtn = document.getElementById('startModeButton');
            
            let currentSlide = 0;
            
            // Устанавливаем начальный активный слайд
            updateSlides();
            
            // Обработчики для кликов по слайдам
            slides.forEach((slide, index) => {
                slide.addEventListener('click', (e) => {
                    // Если клик по левому слайду - перейти к предыдущему
                    if (slide.classList.contains('left')) {
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        updateSlides();
                    }
                    // Если клик по правому слайду - перейти к следующему
                    else if (slide.classList.contains('right')) {
                        currentSlide = (currentSlide + 1) % slides.length;
                        updateSlides();
                    }
                    // Если клик по активному слайду - ничего не делаем (можно выбрать режим)
                });
            });
            
            // Обработчик для кнопки старта
            startBtn.addEventListener('click', () => {
                const activeSlide = document.querySelector('.mode-slide.active');
                const mode = activeSlide.getAttribute('data-mode');
                selectGameMode(mode);
            });
            
            // Функция обновления слайдов
            function updateSlides() {
                slides.forEach((slide, index) => {
                    slide.classList.remove('active', 'left', 'right');
                    
                    if (index === currentSlide) {
                        slide.classList.add('active');
                    } else if (index === (currentSlide - 1 + slides.length) % slides.length) {
                        slide.classList.add('left');
                    } else if (index === (currentSlide + 1) % slides.length) {
                        slide.classList.add('right');
                    }
                });
            }
            
            // Добавляем поддержку свайпов
            let touchStartX = 0;
            let touchEndX = 0;
            
            const carousel = document.querySelector('.mode-carousel');
            
            carousel.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            carousel.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Свайп влево - следующий слайд
                    currentSlide = (currentSlide + 1) % slides.length;
                    updateSlides();
                } else if (touchEndX > touchStartX + swipeThreshold) {
                    // Свайп вправо - предыдущий слайд
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                    updateSlides();
                }
            }
        }

        // Инициализация магазина оружия
        function initWeaponsMenu() {
            const weaponItems = document.querySelectorAll('.weapon-item');
            
            weaponItems.forEach(item => {
                const weaponType = item.getAttribute('data-weapon');
                const buyButton = item.querySelector('.buy-button');
                const selectButton = item.querySelector('.select-button');
                const selectedButton = item.querySelector('.selected-button');
                
                // Обработчик кнопки покупки
                if (buyButton) {
                    buyButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        buyWeapon(weaponType, item);
                    });
                }
                
                // Обработчик кнопки выбора
                if (selectButton) {
                    selectButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectWeapon(weaponType, item);
                    });
                }
                
                // Обработчик клика по всему предмету
                item.addEventListener('click', () => {
                    if (selectButton && selectButton.style.display !== 'none') {
                        selectWeapon(weaponType, item);
                    } else if (buyButton && buyButton.style.display !== 'none') {
                        buyWeapon(weaponType, item);
                    }
                });
            });
        }

        // Обновление магазина оружия
        function updateWeaponsMenu() {
            const weaponItems = document.querySelectorAll('.weapon-item');
            const playerCoins = settingsManager.getCoins();
            
            weaponItems.forEach(item => {
                const weaponType = item.getAttribute('data-weapon');
                const buyButton = item.querySelector('.buy-button');
                const selectButton = item.querySelector('.select-button');
                const selectedButton = item.querySelector('.selected-button');
                const priceElement = item.querySelector('.weapon-price');
                
                // Проверяем, куплено ли оружие
                const isOwned = settingsManager.isWeaponOwned(weaponType);
                const isSelected = settingsManager.getSelectedWeapon() === weaponType;
                
                if (isOwned) {
                    // Оружие куплено
                    if (buyButton) buyButton.style.display = 'none';
                    if (selectButton) selectButton.style.display = isSelected ? 'none' : 'block';
                    if (selectedButton) selectedButton.style.display = isSelected ? 'block' : 'none';
                    
                    if (priceElement) {
                        priceElement.textContent = 'КУПЛЕНО';
                        priceElement.style.color = '#44ff44';
                    }
                } else {
                    // Оружие не куплено
                    if (buyButton) buyButton.style.display = 'block';
                    if (selectButton) selectButton.style.display = 'none';
                    if (selectedButton) selectedButton.style.display = 'none';
                    
                    // Проверяем, хватает ли монет
                    const weaponPrice = getWeaponPrice(weaponType);
                    const canAfford = playerCoins >= weaponPrice;
                    
                    if (buyButton) {
                        buyButton.style.opacity = canAfford ? '1' : '0.5';
                        buyButton.style.cursor = canAfford ? 'pointer' : 'not-allowed';
                    }
                    
                    if (priceElement) {
                        priceElement.textContent = weaponPrice + ' МОНЕТ';
                        priceElement.style.color = canAfford ? 'gold' : '#ff4444';
                    }
                }
            });
        }

        // Функция покупки оружия
        function buyWeapon(weaponType, item) {
            const weaponPrice = getWeaponPrice(weaponType);
            const playerCoins = settingsManager.getCoins();
            
            if (playerCoins >= weaponPrice) {
                if (settingsManager.buyWeapon(weaponType, weaponPrice)) {
                    updateWeaponsMenu();
                    updateCoinCounter();
                    // Автоматически выбираем купленное оружие
                    selectWeapon(weaponType, item);
                }
            } else {
                alert('Недостаточно монет!');
            }
        }

        // Функция выбора оружия
        function selectWeapon(weaponType, item) {
            if (settingsManager.isWeaponOwned(weaponType)) {
                settingsManager.selectWeapon(weaponType);
                updateWeaponsMenu();
                
                // Обновляем изображение оружия в игре
                updateWeaponImage();
            }
        }

        // Получение цены оружия
        function getWeaponPrice(weaponType) {
            const prices = {
                'default': 0,
                'single': 100
            };
            return prices[weaponType] || 0;
        }

        // Обновление изображения оружия в игре
        function updateWeaponImage() {
            const selectedWeapon = settingsManager.getSelectedWeapon();
            const weaponElement = document.getElementById('weapon');
            
            if (selectedWeapon === 'single') {
                weaponElement.src = 'Guns/SingleShootGun/Gun.png';
            } else {
                weaponElement.src = 'Guns/DefaultShootGun/Gun.png';
            }
        }

        // Функция выбора режима игры
        function selectGameMode(mode) {
            currentGameMode = mode;
            
            // Создаем лабиринт в зависимости от режима
            mazeGen = new MazeGenerator(25, 25, mode);
            maze = mazeGen.getMaze();
            
            // Создаем систему навигации
            navigationSystem = new NavigationSystem();
            
            // Устанавливаем стартовую позицию
            if (mode === 'straight') {
                startPos = findCornerStartPosition();
            } else {
                startPos = findRandomStartPosition();
            }
            
            camera.position.set(startPos.x, 1.7, startPos.z);
            
            // Пересоздаем сцену
            const materials = createMaterials();
            createScene(materials);
            
            // Запускаем игру
            startGame();
        }

        // ЖЕСТКИЙ ЗАПРЕТ КОНТЕКСТНОГО МЕНЮ И ПЕРЕТАСКИВАНИЯ
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Настройки
        document.getElementById('sensitivitySlider').addEventListener('input', function(e) {
            const sensitivity = parseInt(e.target.value);
            mouseSensitivity = sensitivity * 0.0004;
            settingsManager.updateSetting('sensitivity', sensitivity);
        });

        document.getElementById('musicVolumeSlider').addEventListener('input', function(e) {
            const volume = parseInt(e.target.value);
            musicVolume = volume / 100;
            settingsManager.updateSetting('musicVolume', volume);
            updateVolumes();
        });

        document.getElementById('soundVolumeSlider').addEventListener('input', function(e) {
            const volume = parseInt(e.target.value);
            soundVolume = volume / 100;
            settingsManager.updateSetting('soundVolume', volume);
            updateVolumes();
        });

        // Запуск игры после загрузки
        window.addEventListener('load', function() {
            loadTextures().then(() => {
                // Создаем начальный лабиринт (будет пересоздан при выборе режима)
                mazeGen = new MazeGenerator(25, 25);
                maze = mazeGen.getMaze();
                navigationSystem = new NavigationSystem();
                
                const materials = createMaterials();
                createScene(materials);
                initAudio();
                initControls();
                initMenu();
                weapon.style.display = 'none';
                
                // Обновляем изображение оружия согласно сохраненным настройкам
                updateWeaponImage();
                
                preloadWeaponImages();
            }).catch((error) => {
                console.error('Ошибка загрузки:', error);
                // Создаем начальный лабиринт (будет пересоздан при выборе режима)
                mazeGen = new MazeGenerator(25, 25);
                maze = mazeGen.getMaze();
                navigationSystem = new NavigationSystem();
                
                const materials = createMaterials();
                createScene(materials);
                initAudio();
                initControls();
                initMenu();
                weapon.style.display = 'none';
                
                // Обновляем изображение оружия согласно сохраненным настройкам
                updateWeaponImage();
                
                preloadWeaponImages();
            });
        });
    </script>
</body>
</html>
